<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è²¡å¸ƒå›</title>

    <link rel="apple-touch-icon" href="icon.PNG">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="è²¡å¸ƒå›">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&family=Noto+Sans+TC:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* åŸºç¤è®Šæ•¸ï¼šæš–å¿ƒç„¦ç³– */
        :root {
            --cream: #FFFDF9;
            --latte: #F5EBE0;
            --caramel: #D4A373;
            --cocoa: #3D2311; 
            --soft-brown: #6D4C41; 
            --accent-glow: rgba(212, 163, 115, 0.3);
            --card-border: rgba(212, 163, 115, 0.15);
        }

        /* æµªæ¼«ç²‰æ«» */
        body.theme-pink {
            --latte: #FFF0F3;
            --caramel: #FFB3C1;
            --cocoa: #5C1D27; 
            --soft-brown: #8E4453; 
            --cream: #FFFFFF;
            --accent-glow: rgba(255, 179, 193, 0.4);
            --card-border: rgba(255, 179, 193, 0.2);
        }

        /* æ¸…çˆ½æµ·æ´‹ */
        body.theme-dark {
            --latte: #E0FBFC; 
            --caramel: #3D5A80; 
            --cocoa: #293241; 
            --soft-brown: #566E8F; 
            --cream: #F8FDFF;
            --accent-glow: rgba(61, 90, 128, 0.2);
            --card-border: rgba(61, 90, 128, 0.1);
        }

        /* æ£®æ—å¤§åœ° */
        body.theme-green {
            --latte: #DFE8D3; 
            --caramel: #82A081;
            --cocoa: #1B3022; 
            --soft-brown: #3E5444; 
            --cream: #F4F9F1;
            --accent-glow: rgba(130, 160, 129, 0.4);
            --card-border: rgba(130, 160, 129, 0.2);
        }

        body {
            font-family: 'Quicksand', 'Noto Sans TC', sans-serif;
            background-color: var(--latte);
            color: var(--cocoa);
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            transition: all 0.4s ease;
        }

        .kawaii-card {
            background: var(--cream);
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            border: 2px solid var(--card-border);
            position: relative;
            transition: background 0.4s ease, border 0.4s ease;
        }

        .main-nav-container {
            position: relative;
            display: flex;
            width: 100%;
            justify-content: space-around;
            margin-top: 32px;
            border-bottom: 1px solid var(--accent-glow);
        }

        .main-nav-btn {
            position: relative;
            flex: 1;
            padding: 12px 0;
            font-size: 15px;
            font-weight: 700;
            color: var(--soft-brown);
            opacity: 0.5;
            transition: all 0.3s ease;
            text-align: center;
            z-index: 10;
        }

        .main-nav-btn.active {
            opacity: 1;
            color: var(--cocoa);
        }

        .nav-underline {
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 33.33%; 
            height: 3px;
            background: var(--caramel);
            border-radius: 10px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20;
        }

        .sub-nav-btn {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 700;
            border-radius: 20px;
            transition: all 0.3s ease;
            color: var(--soft-brown);
            border: 1px solid transparent;
        }
        .sub-nav-btn.active {
            background: var(--cocoa);
            color: var(--cream);
            box-shadow: 0 4px 10px var(--accent-glow);
        }

        .savings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
            gap: 12px;
        }

        .grid-item {
            aspect-ratio: 1 / 1;
            background: var(--cream);
            border-radius: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1.5px solid var(--accent-glow);
            color: var(--soft-brown);
            cursor: pointer;
        }

        .grid-item.completed {
            background-color: var(--caramel);
            border-color: var(--caramel);
            color: var(--cream);
            transform: scale(0.95);
            cursor: default;
        }

        .modal {
            transition: all 0.3s ease;
            pointer-events: none;
            opacity: 0;
            backdrop-filter: blur(8px);
            z-index: 100;
        }
        .modal.active {
            pointer-events: auto;
            opacity: 1;
        }

        .heart-filling-container {
            width: 80px;
            height: 80px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .base-heart { fill: var(--latte); opacity: 0.8; }
        .fill-heart { fill: var(--caramel); transition: all 1s cubic-bezier(0.4, 0, 0.2, 1); }

        .heart-particle {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 9999;
            color: var(--caramel);
            filter: drop-shadow(0 0 12px var(--accent-glow));
            opacity: 0;
        }

        @keyframes heartPulseCenter {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            40% { transform: translate(-50%, -50%) scale(1.6); opacity: 1; }
            70% { transform: translate(-50%, -50%) scale(1.4); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.4); opacity: 1; }
        }

        .pulse-active { animation: heartPulseCenter 0.7s ease-out forwards; }
        .fly-to-target { transition: all 0.8s cubic-bezier(0.5, 0, 0.5, 1); }
        .btn-hover:active { transform: scale(0.95); }

        .ledger-item {
            background: var(--cream);
            border-radius: 20px;
            padding: 14px 18px;
            border: 1px solid var(--card-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            transition: all 0.4s ease;
        }

        .type-btn {
            flex: 1;
            padding: 12px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .type-btn.income { background: rgba(34, 197, 94, 0.1); color: #166534; }
        .type-btn.expense { background: rgba(239, 68, 68, 0.1); color: #991b1b; }
        .type-btn.active.income { background: #22c55e; color: white; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); }
        .type-btn.active.expense { background: #ef4444; color: white; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
        
        .ledger-input-group {
            background: var(--cream);
            border-radius: 28px;
            padding: 24px;
            border: 2px solid var(--card-border);
            transition: all 0.4s ease;
        }

        .custom-input {
            background: rgba(0,0,0,0.04);
            border: none;
            border-radius: 16px;
            padding: 14px;
            color: var(--cocoa);
            transition: all 0.3s ease;
        }
        .custom-input:focus {
            background: var(--latte);
            box-shadow: inset 0 0 0 2px var(--caramel);
        }

        .theme-swatch {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid var(--cream);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }
        .theme-swatch.active {
            transform: scale(1.2);
            border-color: var(--caramel);
            box-shadow: 0 0 15px var(--caramel);
        }

        /* æ”¹ç‰ˆå¾Œçš„æ¯æœˆç¸½çµå¡ç‰‡æ¨£å¼ */
        .summary-card-v2 {
            background: var(--cream);
            border-radius: 28px;
            padding: 24px;
            border: 2px solid var(--card-border);
            position: relative;
            overflow: hidden;
        }
        .summary-card-v2::before {
            content: '';
            position: absolute;
            top: 0; right: 0;
            width: 100px; height: 100px;
            background: var(--caramel);
            opacity: 0.05;
            border-radius: 0 0 0 100%;
        }
        .stat-progress-bg {
            height: 8px;
            background: rgba(0,0,0,0.05);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        .stat-progress-fill {
            height: 100%;
            background: var(--caramel);
            transition: width 1s ease;
        }

        .month-selector-v2 {
            background: var(--latte);
            padding: 6px 12px;
            border-radius: 12px;
            color: var(--cocoa);
            font-weight: 700;
            font-size: 13px;
            border: none;
            outline: none;
            cursor: pointer;
        }

        /* å¶åƒåˆ—è¡¨æ©«å‘æ»¾å‹• */
        .idol-scroll-container {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding: 4px;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .idol-scroll-container::-webkit-scrollbar { display: none; }
        
        .idol-chip {
            padding: 8px 16px;
            background: var(--cream);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            white-space: nowrap;
            border: 1.5px solid var(--card-border);
            transition: all 0.3s ease;
        }
        .idol-chip.active {
            background: var(--caramel);
            color: var(--cream);
            border-color: var(--caramel);
        }
        .add-idol-btn {
            width: 34px;
            height: 34px;
            min-width: 34px;
            border-radius: 50%;
            background: var(--cocoa);
            color: var(--cream);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 10px var(--accent-glow);
        }
    </style>
</head>
<body class="pb-10">

    <!-- ç¸½é¡é ­éƒ¨ -->
    <header class="p-8 pt-12 flex flex-col items-center">
        <div class="relative flex items-center gap-2">
            <span class="text-[11px] font-bold tracking-[0.2em] opacity-60 uppercase">TOTAL SAVINGS</span>
            <div class="w-3 h-3 text-caramel">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            </div>
        </div>
        <div class="flex items-baseline gap-1 mt-1">
            <span class="text-5xl font-bold tracking-tight" id="header-total">0</span>
            <span class="text-xs font-bold text-caramel uppercase">TWD</span>
        </div>

        <nav class="main-nav-container">
            <button onclick="switchMainPage('savings')" id="main-nav-savings" class="main-nav-btn active">å­˜éŒ¢è¨ˆç•«</button>
            <button onclick="switchMainPage('ledger')" id="main-nav-ledger" class="main-nav-btn">æ—¥å¸¸è¨˜å¸³</button>
            <button onclick="switchMainPage('settings')" id="main-nav-settings" class="main-nav-btn">ç³»çµ±è¨­å®š</button>
            <div id="nav-underline" class="nav-underline"></div>
        </nav>
    </header>

    <!-- ç¬¬ä¸€åˆ†é ï¼šå­˜éŒ¢è¨ˆç•« -->
    <main id="page-savings" class="px-6 space-y-6">
        <div class="flex justify-center gap-2 mb-2">
            <button onclick="switchTab(1)" id="sub-nav-1" class="sub-nav-btn active">50å…ƒé›¶éŒ¢</button>
            <button onclick="switchTab(2)" id="sub-nav-2" class="sub-nav-btn">365å¤©æŒ‘æˆ°</button>
            <button onclick="switchTab(3)" id="sub-nav-3" class="sub-nav-btn">å¶åƒæ‡‰æ´</button>
        </div>

        <!-- 50å…ƒè¨ˆç•« -->
        <section id="pane-1" class="tab-pane">
            <div class="kawaii-card p-6 mb-6 flex items-center justify-between">
                <div class="flex-1">
                    <h2 class="text-lg font-bold mb-1">50å…ƒé›¶éŒ¢ç½</h2>
                    <div class="flex flex-col">
                        <span class="text-2xl font-bold text-caramel" id="m1-percentage">0%</span>
                        <span class="text-[10px] font-bold opacity-60 uppercase tracking-widest" id="m1-days-count">å·²å®Œæˆ 0/365å¤©</span>
                        <!-- 50å…ƒé‡ç½®æŒ‰éˆ• -->
                        <button id="m1-reset-btn" onclick="resetPlan('m1')" class="hidden mt-2 bg-caramel text-cream text-[10px] px-3 py-1.5 rounded-full font-bold self-start btn-hover">é”æˆï¼è½‰å…¥è¨˜å¸³ä¸¦é‡æ–°é–‹å§‹</button>
                    </div>
                </div>
                <div class="heart-filling-container" id="heart-target-1">
                    <svg viewBox="0 0 24 24" width="65" height="65">
                        <defs><clipPath id="clip-m1"><rect id="m1-fill-rect" x="0" y="24" width="24" height="0" /></clipPath></defs>
                        <path class="base-heart" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        <path class="fill-heart" clip-path="url(#clip-m1)" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                </div>
            </div>
            <div id="m1-grid" class="savings-grid pb-20"></div>
        </section>

        <!-- 365å¤©è¨ˆç•« -->
        <section id="pane-2" class="tab-pane hidden">
            <div class="kawaii-card p-6 mb-6 flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-[10px] font-bold tracking-widest uppercase opacity-60">æ¯æ—¥æŒ‘æˆ°</p>
                    <h2 class="text-2xl font-bold">365å¤©å­˜éŒ¢ç½</h2>
                    <div class="mt-2 flex items-center gap-2">
                        <span class="text-3xl font-bold text-caramel" id="m2-total">0</span>
                        <span class="text-[10px] opacity-60 font-bold uppercase">ç´¯è¨ˆé‡‘é¡</span>
                    </div>
                    <!-- 365å¤©é‡ç½®æŒ‰éˆ• -->
                    <button id="m2-reset-btn" onclick="resetPlan('m2')" class="hidden mt-3 bg-caramel text-cream text-[10px] px-3 py-1.5 rounded-full font-bold btn-hover">é”æˆæŒ‘æˆ°ï¼çµç®—é‡‘é¡</button>
                </div>
                <div class="heart-filling-container" id="heart-target-2">
                    <svg viewBox="0 0 24 24" width="65" height="65">
                        <defs><clipPath id="clip-m2"><rect id="m2-fill-rect" x="0" y="24" width="24" height="0" /></clipPath></defs>
                        <path class="base-heart" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        <path class="fill-heart" clip-path="url(#clip-m2)" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                </div>
            </div>
            <div id="m2-grid" class="savings-grid pb-20"></div>
        </section>

        <!-- å¶åƒæ‡‰æ´ -->
        <section id="pane-3" class="tab-pane hidden">
            <div class="flex items-center gap-3 mb-4">
                <button onclick="createNewIdol()" class="add-idol-btn btn-hover">+</button>
                <div id="idol-list-chips" class="idol-scroll-container flex-1"></div>
            </div>

            <div class="kawaii-card p-8 mb-6 relative">
                <button onclick="deleteCurrentIdol()" class="absolute top-4 right-4 opacity-20 hover:opacity-100 transition-opacity">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>
                </button>

                <div class="flex justify-between items-center mb-6">
                    <input id="idol-name" type="text" placeholder="è¼¸å…¥å¶åƒåç¨±" class="flex-1 bg-transparent border-none focus:ring-0 text-xl font-bold placeholder:opacity-30">
                    <div class="heart-filling-container" id="heart-target-3">
                        <svg viewBox="0 0 24 24" width="65" height="65">
                            <defs><clipPath id="clip-m3"><rect id="m3-fill-rect" x="0" y="24" width="24" height="0" /></clipPath></defs>
                            <path class="base-heart" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            <path class="fill-heart" clip-path="url(#clip-m3)" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                    </div>
                </div>
                <div class="my-6 py-6 border-y border-dashed border-stone-200 text-center">
                    <div id="goal-ui-setup" class="flex flex-col items-center">
                        <p class="text-[10px] font-bold opacity-60 mb-4 tracking-widest uppercase">è¨­å®šç›®æ¨™é‡‘é¡</p>
                        <div class="flex items-center gap-2">
                            <span class="text-xl font-bold text-caramel">$</span>
                            <input id="goal-input" type="number" placeholder="0000" class="w-28 bg-transparent border-none focus:ring-0 text-2xl font-bold text-center">
                            <button onclick="askConfirmGoal()" class="bg-cocoa text-cream text-[10px] font-bold px-4 py-2 rounded-xl btn-hover">è¨­å®š</button>
                        </div>
                    </div>
                    <div id="goal-ui-locked" class="hidden flex flex-col items-center">
                        <p class="text-[10px] font-bold text-caramel mb-2 tracking-widest uppercase">æ‡‰æ´ç´¯ç©ä¸­</p>
                        <h2 class="text-5xl font-bold" id="m3-total-display">0</h2>
                        <p id="goal-diff-text" class="text-[11px] mt-2 font-bold"></p>
                        <!-- å¶åƒé”æˆé‡ç½®æŒ‰éˆ• -->
                        <button id="idol-reset-btn" onclick="resetPlan('m3')" class="mt-4 hidden bg-caramel text-cream text-[10px] px-6 py-2 rounded-full font-bold shadow-lg btn-hover">é”æˆä¸¦é–‹å•Ÿæ–°ç›®æ¨™ï¼</button>
                    </div>
                </div>
                <!-- å¿«æ·æ‡‰æ´éˆ• -->
                <div class="grid grid-cols-2 gap-3 pb-10">
                    <button onclick="askConfirm('Idol', 10, 'Story')" class="p-4 bg-latte/40 rounded-2xl text-left btn-hover border border-white">
                        <p class="text-[9px] font-bold text-caramel mb-1 uppercase">Story</p>
                        <p class="text-xs font-bold">é™æ™‚å‹•æ…‹</p>
                        <p class="text-[10px] opacity-60 font-bold mt-1">$10</p>
                    </button>
                    <button onclick="askConfirm('Idol', 20, 'Reels')" class="p-4 bg-latte/40 rounded-2xl text-left btn-hover border border-white">
                        <p class="text-[9px] font-bold text-caramel mb-1 uppercase">Reels</p>
                        <p class="text-xs font-bold">REELS</p>
                        <p class="text-[10px] opacity-60 font-bold mt-1">$20</p>
                    </button>
                    <button onclick="askConfirm('Idol', 30, 'FC')" class="p-4 bg-latte/40 rounded-2xl text-left btn-hover border border-white">
                        <p class="text-[9px] font-bold text-caramel mb-1 uppercase">FC</p>
                        <p class="text-xs font-bold">FC æ›´æ–°</p>
                        <p class="text-[10px] opacity-60 font-bold mt-1">$30</p>
                    </button>
                    <button onclick="askConfirm('Idol', 50, 'Post')" class="p-4 bg-latte/40 rounded-2xl text-left btn-hover border border-white">
                        <p class="text-[9px] font-bold text-caramel mb-1 uppercase">Post</p>
                        <p class="text-xs font-bold">ç™¼å¸ƒè²¼æ–‡</p>
                        <p class="text-[10px] opacity-60 font-bold mt-1">$50</p>
                    </button>
                    <button onclick="askConfirm('Idol', 100, 'Live')" class="p-4 bg-latte/40 rounded-2xl text-left btn-hover border border-white">
                        <p class="text-[9px] font-bold text-caramel mb-1 uppercase">Live</p>
                        <p class="text-xs font-bold">å½±éŸ³ç›´æ’­</p>
                        <p class="text-[10px] opacity-60 font-bold mt-1">$100</p>
                    </button>
                     <button onclick="askConfirm('Idol', 150, 'Events')" class="p-4 bg-latte/40 rounded-2xl text-left btn-hover border border-white">
                        <p class="text-[9px] font-bold text-caramel mb-1 uppercase">Events</p>
                        <p class="text-xs font-bold">éŸ³ç•ªç¯€ç›®</p>
                        <p class="text-xs font-bold">å…¶ä»–æ´»å‹•</p>
                        <p class="text-[10px] opacity-60 font-bold mt-1">$150</p>
                     </button>
                </div>
            </div>
        </section>
    </main>

    <!-- æ—¥å¸¸è¨˜å¸³ã€ç³»çµ±è¨­å®šã€Modal (ä¿æŒä¸è®Š) -->
    <!-- ... æ­¤è™•çœç•¥éƒ¨åˆ†é‡è¤‡çš„ HTML ä»£ç¢¼ä»¥ä¿æŒç°¡æ½” ... -->
    <!-- ç¬¬äºŒåˆ†é ï¼šæ—¥å¸¸è¨˜å¸³ -->
    <main id="page-ledger" class="px-6 space-y-6 hidden">
        <div class="summary-card-v2 shadow-lg">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h3 class="text-[11px] font-bold opacity-40 uppercase tracking-[0.2em] mb-1">Monthly Analytics</h3>
                    <select id="summary-month-select" onchange="renderSummary()" class="month-selector-v2"></select>
                </div>
                <div class="text-right">
                    <p id="summary-net-label" class="text-[9px] font-bold opacity-40 uppercase mb-1">Net Balance</p>
                    <p id="summary-net" class="text-xl font-bold">$0</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-6">
                <div class="space-y-1">
                    <div class="flex justify-between items-baseline">
                        <span class="text-[10px] font-bold opacity-60 uppercase">æ”¯å‡º</span>
                        <span id="summary-expense" class="text-sm font-bold text-red-500">$0</span>
                    </div>
                    <div class="stat-progress-bg">
                        <div id="exp-progress" class="stat-progress-fill bg-red-400" style="width: 0%"></div>
                    </div>
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between items-baseline">
                        <span class="text-[10px] font-bold opacity-60 uppercase">æ”¶å…¥</span>
                        <span id="summary-income" class="text-sm font-bold text-green-600">$0</span>
                    </div>
                    <div class="stat-progress-bg">
                        <div id="inc-progress" class="stat-progress-fill bg-green-400" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="ledger-input-group shadow-sm">
            <div class="flex gap-3 mb-5 p-1 bg-black/5 rounded-2xl">
                <button id="type-exp" onclick="setLedgerType('expense')" class="type-btn expense active">æ”¯å‡º</button>
                <button id="type-inc" onclick="setLedgerType('income')" class="type-btn income">æ”¶å…¥</button>
            </div>
            <div class="space-y-4">
                <div class="flex gap-3">
                    <div class="relative w-28">
                        <select id="ledger-cat" class="w-full custom-input text-xs font-bold appearance-none">
                            <option value="é£²é£Ÿ">ğŸ± é£²é£Ÿ</option>
                            <option value="äº¤é€š">ğŸš— äº¤é€š</option>
                            <option value="è³¼ç‰©">ğŸ›ï¸ è³¼ç‰©</option>
                            <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
                            <option value="è–ªæ°´">ğŸ’° è–ªæ°´</option>
                            <option value="å…¶ä»–">âœ¨ å…¶ä»–</option>
                        </select>
                        <div class="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none opacity-30">
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg>
                        </div>
                    </div>
                    <input id="ledger-amt" type="number" inputmode="numeric" placeholder="é‡‘é¡" class="flex-1 custom-input text-sm font-bold">
                </div>
                <input id="ledger-note" type="text" placeholder="å¯«é»å‚™è¨»å§..." class="w-full custom-input text-sm font-bold">
                <button onclick="addLedger()" class="w-full py-4 bg-cocoa text-cream rounded-2xl text-[13px] font-bold uppercase tracking-widest btn-hover shadow-lg mt-2">
                    æ–°å¢é€™ç­†ç´€éŒ„
                </button>
            </div>
        </div>

        <div class="space-y-4">
            <div class="flex items-center justify-between px-2">
                <h3 class="text-[11px] font-bold opacity-40 tracking-[0.2em] uppercase">Recent Transactions</h3>
                <span id="ledger-count" class="text-[10px] opacity-40 font-bold italic"></span>
            </div>
            <div id="ledger-list" class="space-y-3 pb-10"></div>
        </div>
    </main>

    <!-- ç¬¬ä¸‰åˆ†é ï¼šç³»çµ±è¨­å®š -->
    <main id="page-settings" class="px-6 space-y-6 hidden">
        <div class="kawaii-card p-8">
            <h3 class="text-xs font-bold text-caramel uppercase tracking-widest mb-6">ä¸»é¡Œé…è‰²</h3>
            <div class="flex justify-around items-center">
                <div class="flex flex-col items-center gap-3">
                    <button id="swatch-default" onclick="setTheme('')" class="theme-swatch active" style="background: #3D2311;"></button>
                    <span class="text-[10px] font-bold opacity-60">æš–å¿ƒç„¦ç³–</span>
                </div>
                <div class="flex flex-col items-center gap-3">
                    <button id="swatch-pink" onclick="setTheme('theme-pink')" class="theme-swatch" style="background: #FFB3C1;"></button>
                    <span class="text-[10px] font-bold opacity-60">æµªæ¼«ç²‰æ«»</span>
                </div>
                <div class="flex flex-col items-center gap-3">
                    <button id="swatch-dark" onclick="setTheme('theme-dark')" class="theme-swatch" style="background: #3D5A80;"></button>
                    <span class="text-[10px] font-bold opacity-60">æ¸…çˆ½æµ·æ´‹</span>
                </div>
                <div class="flex flex-col items-center gap-3">
                    <button id="swatch-green" onclick="setTheme('theme-green')" class="theme-swatch" style="background: #1B3022;"></button>
                    <span class="text-[10px] font-bold opacity-60">æ£®æ—å¤§åœ°</span>
                </div>
            </div>
        </div>

        <div class="kawaii-card p-8">
            <h3 class="text-xs font-bold text-caramel uppercase tracking-widest mb-4">æ¯æ—¥å­˜éŒ¢æé†’</h3>
            <div class="bg-black/5 rounded-2xl p-5 space-y-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm font-bold">æé†’æ™‚é–“</span>
                    <input type="time" id="reminder-time" class="bg-white/10 px-3 py-1 rounded-lg border-none font-bold focus:ring-0">
                </div>
                <button id="notification-toggle" onclick="toggleNotifications()" class="w-full py-4 rounded-2xl text-xs font-bold uppercase transition-all btn-hover border border-black/10">
                    é–‹å•Ÿæé†’åŠŸèƒ½
                </button>
                <div class="space-y-1">
                    <p class="text-[10px] text-stone-400 font-bold">â€¢ æé†’åŠŸèƒ½éœ€åœ¨ HTTPS ç’°å¢ƒä¸‹é‹ä½œã€‚</p>
                    <p class="text-[10px] text-stone-400 font-bold">â€¢ å»ºè­°å°‡æ­¤ç¶²é ã€ŒåŠ å…¥ä¸»ç•«é¢ã€å¾Œé–‹å•Ÿã€‚</p>
                </div>
                <p class="text-[13px] text-soft-brown font-bold italic text-center pt-2">è²¡å¸ƒå›æœƒæº–æ™‚æé†’æ‚¨å”·ï¼(Ùˆ'Ï‰')Ùˆ</p>
            </div>
        </div>

        <div class="kawaii-card p-8 border-red-500/20">
            <h3 class="text-xs font-bold text-red-500 uppercase tracking-widest mb-4">å±éšªå€åŸŸ</h3>
            <button onclick="resetData()" class="w-full py-4 bg-red-500/5 text-red-600 rounded-2xl text-xs font-bold uppercase tracking-widest btn-hover border border-red-500/10">
                æ¸…ç©ºæ‰€æœ‰å„²è“„ç´€éŒ„
            </button>
        </div>
    </main>

    <!-- Modal -->
    <div id="modal" class="modal fixed inset-0 flex items-center justify-center p-10">
        <div class="absolute inset-0 bg-black/40" onclick="closeModal()"></div>
        <div class="kawaii-card w-full max-w-xs p-8 relative z-10 text-center mx-auto transform transition-all scale-100">
            <div id="modal-icon-container" class="absolute -top-10 left-1/2 -translate-x-1/2 bg-white rounded-full p-3 border-4 border-latte shadow-lg">
                <svg id="modal-icon" viewBox="0 0 24 24" width="30" height="30" class="text-caramel"><path fill="currentColor" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
            </div>
            <h3 id="modal-title" class="text-sm font-bold mt-2 mb-3 tracking-widest"></h3>
            <div id="modal-desc" class="text-xs opacity-80 mb-8 leading-relaxed px-2"></div>
            <div class="flex gap-4" id="modal-buttons">
                <button id="modal-cancel-btn" onclick="closeModal()" class="flex-1 py-3 text-[11px] font-bold opacity-50 uppercase tracking-widest">å–æ¶ˆ</button>
                <button id="modal-btn" class="flex-[1.5] py-3 bg-cocoa text-cream rounded-2xl text-[11px] font-bold uppercase tracking-widest shadow-lg btn-hover">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <script>
        let state = { 
            m1: [], m2: [], 
            idols: [
                { id: Date.now(), name: "", total: 0, goal: 0, locked: false }
            ],
            activeIdolIndex: 0,
            reminderTime: "21:00", notificationsEnabled: false,
            mainPage: 'savings',
            ledger: [], 
            ledgerType: 'expense',
            theme: '' 
        };

// æ ¸å¿ƒè¨­å®šï¼šç‰ˆæœ¬ Key åç¨±
        const OLD_KEY = 'caramel_heart_v36'; 
        const NEW_KEY = 'caramel_heart_v36_ledger_v3_multi_idol';

        function init() {
            const newData = localStorage.getItem(NEW_KEY);
            const oldData = localStorage.getItem(OLD_KEY);

            if (newData) {
                // å¦‚æœå·²ç¶“æœ‰æ–°ç‰ˆè³‡æ–™ï¼Œç›´æ¥è¼‰å…¥
                state = JSON.parse(newData);
            } else if (oldData) {
                // ã€è‡ªå‹•æ¬å®¶é‚è¼¯ã€‘åµæ¸¬åˆ°èˆŠç‰ˆè³‡æ–™ï¼Œé€²è¡Œå‡ç´šæ¬é‹
                const parsedOld = JSON.parse(oldData);
                
                state.m1 = parsedOld.m1 || [];
                state.m2 = parsedOld.m2 || [];
                state.ledger = parsedOld.ledger || [];
                state.theme = parsedOld.theme || '';
                state.reminderTime = parsedOld.reminderTime || "21:00";
                state.notificationsEnabled = parsedOld.notificationsEnabled || false;
                
                // å°‡èˆŠç‰ˆã€Œå–®ä¸€å¶åƒã€æ ¼å¼è½‰æ›ç‚ºæ–°ç‰ˆã€Œé™£åˆ—ã€æ ¼å¼
                if (parsedOld.idols) {
                    state.idols = parsedOld.idols;
                    state.activeIdolIndex = parsedOld.activeIdolIndex || 0;
                } else {
                    state.idols = [{ 
                        id: Date.now(), 
                        name: parsedOld.idolName || "", 
                        total: parsedOld.m3Total || 0, 
                        goal: parsedOld.goal || 0, 
                        locked: parsedOld.locked || false 
                    }];
                    state.activeIdolIndex = 0;
                }
                
                // æ¬å®¶å¾Œç«‹åˆ»å­˜å…¥æ–°ç‰ˆ Key
                save();
                console.log("è³‡æ–™æˆåŠŸå¾ v36 æ¬é·è‡³æ–°ç‰ˆï¼");
            }
            
            // ç¶å®š UI äº‹ä»¶
            document.getElementById('idol-name').oninput = (e) => { 
                state.idols[state.activeIdolIndex].name = e.target.value; 
                save(); 
                renderIdolChips(); 
            };
            document.getElementById('reminder-time').value = state.reminderTime || "21:00";
            document.getElementById('reminder-time').onchange = (e) => { state.reminderTime = e.target.value; save(); };
            
            if (state.theme) setTheme(state.theme);
            
            populateMonthSelect();
            renderGrids();
            renderIdolChips();
            renderLedger();
            renderSummary();
            updateUI();
            checkNotificationStatus();
            switchMainPage(state.mainPage || 'savings');
            switchTab(state.activeTab || 1);
            setInterval(checkReminder, 60000);
        }

        function save() { 
            // æ¯æ¬¡ä¿å­˜éƒ½æœƒå¯«å…¥æœ€æ–°çš„ NEW_KEY
            localStorage.setItem(NEW_KEY, JSON.stringify(state)); 
        }

        // --- æ–°å¢ï¼šé‡ç½®è¨ˆç•«é‚è¼¯ ---
        function resetPlan(planType) {
            let amountToRecord = 0;
            let title = "";
            let confirmMsg = "";

            if (planType === 'm1') {
                amountToRecord = state.m1.length * 50;
                title = "50å…ƒè¨ˆç•«é”æˆï¼";
                confirmMsg = `é€™ä¸€è¼ªå…±å­˜äº† $${amountToRecord}ï¼Œç¢ºèªè¦é–‹å•Ÿæ–°ä¸€è¼ªä¸¦æ¸…ç©ºæ ¼é»å—ï¼Ÿ`;
            } else if (planType === 'm2') {
                amountToRecord = state.m2.reduce((a, b) => a + b, 0);
                title = "365å¤©æŒ‘æˆ°é”æˆï¼";
                confirmMsg = `é€™ä¸€è¼ªå…±å­˜äº† $${amountToRecord}ï¼Œç¢ºèªè¦é–‹å•Ÿæ–°ä¸€è¼ªä¸¦æ¸…ç©ºæ ¼é»å—ï¼Ÿ`;
            } else if (planType === 'm3') {
                const idol = state.idols[state.activeIdolIndex];
                amountToRecord = idol.total;
                title = `å° ${idol.name || 'å¶åƒ'} çš„æ‡‰æ´é”æˆï¼`;
                confirmMsg = `é€™ä¸€æ¬¡æ‡‰æ´å…±å­˜äº† $${amountToRecord}ï¼Œç¢ºèªè¦çµç®—ä¸¦è¨­å®šæ–°ç›®æ¨™å—ï¼Ÿ`;
            }

            showModal(title, confirmMsg, true, "ç¢ºèªçµç®—", () => {
                const now = new Date();
                // å°‡é‡‘é¡å­˜å…¥æ—¥å¸¸è¨˜å¸³ (ä½œç‚ºæ”¶å…¥)
                state.ledger.unshift({
                    id: Date.now(),
                    type: 'income',
                    category: 'ç›®æ¨™é‡ç½®',
                    amount: amountToRecord,
                    note: `[è¨ˆç•«çµç®—] ${title}`,
                    displayDate: now.toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'}),
                    displayTime: now.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', hour12: false}),
                    isoDate: now.toISOString()
                });

                // æ¸…ç©ºæ•¸æ“š
                if (planType === 'm1') state.m1 = [];
                else if (planType === 'm2') state.m2 = [];
                else if (planType === 'm3') {
                    state.idols[state.activeIdolIndex].total = 0;
                    state.idols[state.activeIdolIndex].goal = 0;
                    state.idols[state.activeIdolIndex].locked = false;
                }

                save();
                renderGrids();
                renderLedger();
                renderSummary();
                updateUI();
                closeModal();
                showModal("çµç®—æˆåŠŸ", "é‡‘é¡å·²è¨˜éŒ„åˆ°æ—¥å¸¸è¨˜å¸³ä¸­ï¼Œå¯ä»¥é–‹å§‹æ–°æŒ‘æˆ°å›‰ï¼", false, "å¥½è€¶ï¼");
            });
        }

        function updateUI() {
            // 50å…ƒè¨ˆç•«æ›´æ–°
            const s1 = state.m1.length * 50; 
            const s1Perc = (state.m1.length / 365) * 100;
            updateHeartFill('m1', s1Perc); 
            document.getElementById('m1-percentage').innerText = Math.round(s1Perc) + '%';
            document.getElementById('m1-days-count').innerText = `å·²å®Œæˆ ${state.m1.length}/365å¤©`;
            // å¦‚æœ 100% é¡¯ç¤ºé‡ç½®æŒ‰éˆ•
            document.getElementById('m1-reset-btn').classList.toggle('hidden', s1Perc < 100);
            
            // 365å¤©è¨ˆç•«æ›´æ–°
            const s2 = state.m2.reduce((a,b)=>a+b, 0); 
            const s2Total = (1 + 365) * 365 / 2;
            const s2Perc = (s2 / s2Total) * 100;
            updateHeartFill('m2', s2Perc); 
            document.getElementById('m2-total').innerText = s2.toLocaleString();
            // å¦‚æœå…¨éƒ¨æ ¼é»éƒ½å­˜æ»¿ (365å¤©æ»¿æ ¼) é¡¯ç¤ºé‡ç½®æŒ‰éˆ•
            document.getElementById('m2-reset-btn').classList.toggle('hidden', state.m2.length < 365);
            
            // å¶åƒæ‡‰æ´æ›´æ–°
            const currentIdol = state.idols[state.activeIdolIndex];
            document.getElementById('idol-name').value = currentIdol.name;
            document.getElementById('m3-total-display').innerText = currentIdol.total.toLocaleString();
            
            if (currentIdol.locked && currentIdol.goal > 0) {
                const idolPerc = (currentIdol.total / currentIdol.goal) * 100;
                updateHeartFill('m3', Math.min(100, idolPerc));
                document.getElementById('goal-ui-setup').classList.add('hidden'); 
                document.getElementById('goal-ui-locked').classList.remove('hidden');
                
                const diff = currentIdol.goal - currentIdol.total; 
                document.getElementById('goal-diff-text').innerText = diff <= 0 ? `å·²é”æˆç›®æ¨™ï¼` : `é‚„å·® $${diff.toLocaleString()} é”æˆç›®æ¨™`;
                
                // é¡¯ç¤ºã€Œé”æˆä¸¦é–‹å•Ÿæ–°ç›®æ¨™ã€æŒ‰éˆ•
                document.getElementById('idol-reset-btn').classList.toggle('hidden', diff > 0);
            } else { 
                updateHeartFill('m3', 0); 
                document.getElementById('goal-ui-setup').classList.remove('hidden'); 
                document.getElementById('goal-ui-locked').classList.add('hidden'); 
                document.getElementById('goal-input').value = "";
            }
            
            const allIdolsTotal = state.idols.reduce((acc, curr) => acc + curr.total, 0);
            const ledgerBalance = state.ledger.reduce((acc, curr) => curr.type === 'income' ? acc + curr.amount : acc - curr.amount, 0);
            document.getElementById('header-total').innerText = (s1 + s2 + allIdolsTotal + ledgerBalance).toLocaleString();
        }

        // ... å…¶é¤˜å‡½æ•¸ä¿æŒä¸è®Š (setTheme, switchMainPage, switchTab, renderGrids, addLedger ç­‰) ...
        function setTheme(themeName) {
            document.body.classList.remove('theme-pink', 'theme-dark', 'theme-green');
            if (themeName) document.body.classList.add(themeName);
            state.theme = themeName;
            document.querySelectorAll('.theme-swatch').forEach(s => s.classList.remove('active'));
            if (!themeName) document.getElementById('swatch-default').classList.add('active');
            else if (themeName === 'theme-pink') document.getElementById('swatch-pink').classList.add('active');
            else if (themeName === 'theme-dark') document.getElementById('swatch-dark').classList.add('active');
            else if (themeName === 'theme-green') document.getElementById('swatch-green').classList.add('active');
            save(); updateUI();
        }

        function switchMainPage(page) {
            state.mainPage = page; save();
            document.getElementById('page-savings').classList.toggle('hidden', page !== 'savings');
            document.getElementById('page-ledger').classList.toggle('hidden', page !== 'ledger');
            document.getElementById('page-settings').classList.toggle('hidden', page !== 'settings');
            document.querySelectorAll('.main-nav-btn').forEach(btn => btn.classList.toggle('active', btn.id === `main-nav-${page}`));
            const underline = document.getElementById('nav-underline');
            if (page === 'savings') underline.style.transform = 'translateX(0%)';
            else if (page === 'ledger') underline.style.transform = 'translateX(100%)';
            else if (page === 'settings') underline.style.transform = 'translateX(200%)';
            if(page === 'ledger') { populateMonthSelect(); renderSummary(); renderLedger(); }
        }

        function switchTab(idx) {
            state.activeTab = idx; save();
            document.querySelectorAll('.tab-pane').forEach((p,i) => p.classList.toggle('hidden', i+1 !== idx));
            document.querySelectorAll('.sub-nav-btn').forEach(n => n.classList.remove('active'));
            document.getElementById(`sub-nav-${idx}`).classList.add('active');
        }

        function createNewIdol() {
            const newIdol = { id: Date.now(), name: "IDOL", total: 0, goal: 0, locked: false };
            state.idols.push(newIdol); state.activeIdolIndex = state.idols.length - 1;
            save(); renderIdolChips(); updateUI();
        }

        function selectIdol(index) { state.activeIdolIndex = index; save(); renderIdolChips(); updateUI(); }

        function deleteCurrentIdol() {
            if (state.idols.length <= 1) { showModal("ç„¡æ³•åˆªé™¤", "è‡³å°‘éœ€è¦ä¿ç•™ä¸€å€‹æ‡‰æ´è¨ˆç•«å“¦ï¼", false, "æˆ‘çŸ¥é“äº†"); return; }
            const name = state.idols[state.activeIdolIndex].name || "é€™å€‹å¶åƒ";
            showModal("åˆªé™¤æ‡‰æ´ï¼Ÿ", `ç¢ºå®šè¦åˆªé™¤å° ã€Œ${name}ã€ çš„æ‡‰æ´è¨ˆç•«å—ï¼Ÿ<br><span class="text-red-500 font-bold">ç´¯ç©çš„é‡‘é¡å°‡æœƒæ¶ˆå¤±ï¼</span>`, true, "ç¢ºèªåˆªé™¤", () => {
                state.idols.splice(state.activeIdolIndex, 1); state.activeIdolIndex = Math.max(0, state.activeIdolIndex - 1);
                save(); renderIdolChips(); updateUI(); closeModal();
            });
        }

        function renderIdolChips() {
            const container = document.getElementById('idol-list-chips'); container.innerHTML = '';
            state.idols.forEach((idol, idx) => {
                const chip = document.createElement('button'); chip.className = `idol-chip ${idx === state.activeIdolIndex ? 'active' : ''}`;
                chip.innerText = idol.name || "IDOL"; chip.onclick = () => selectIdol(idx); container.appendChild(chip);
            });
        }

        function setLedgerType(type) {
            state.ledgerType = type;
            document.getElementById('type-exp').classList.toggle('active', type === 'expense');
            document.getElementById('type-inc').classList.toggle('active', type === 'income');
        }

        function addLedger() {
            const amt = parseInt(document.getElementById('ledger-amt').value);
            const cat = document.getElementById('ledger-cat').value;
            const note = document.getElementById('ledger-note').value;
            if(!amt || amt <= 0) return;
            const now = new Date();
            const entry = { id: Date.now(), type: state.ledgerType, category: cat, amount: amt, note: note || cat, displayDate: now.toLocaleDateString('zh-TW', {month:'2-digit', day:'2-digit'}), displayTime: now.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', hour12: false}), isoDate: now.toISOString() };
            state.ledger.unshift(entry); save(); renderLedger(); renderSummary(); updateUI();
            document.getElementById('ledger-amt').value = ''; document.getElementById('ledger-note').value = '';
        }

        function populateMonthSelect() {
            const select = document.getElementById('summary-month-select');
            const currentVal = select.value; select.innerHTML = ''; const months = new Set(); const now = new Date();
            months.add(`${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`);
            state.ledger.forEach(item => { const d = new Date(item.isoDate); months.add(`${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`); });
            Array.from(months).sort().reverse().forEach(m => {
                const opt = document.createElement('option'); opt.value = m; const [y, mm] = m.split('-'); opt.innerText = `${y}å¹´ ${mm}æœˆ`; select.appendChild(opt);
            });
            if(currentVal && Array.from(months).includes(currentVal)) select.value = currentVal;
        }

        function renderSummary() {
            const monthStr = document.getElementById('summary-month-select').value; if(!monthStr) return;
            const filtered = state.ledger.filter(item => { const d = new Date(item.isoDate); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}` === monthStr; });
            const income = filtered.filter(i => i.type === 'income').reduce((a,b) => a + b.amount, 0);
            const expense = filtered.filter(i => i.type === 'expense').reduce((a,b) => a + b.amount, 0);
            const net = income - expense;
            document.getElementById('summary-income').innerText = `$${income.toLocaleString()}`;
            document.getElementById('summary-expense').innerText = `$${expense.toLocaleString()}`;
            const netEl = document.getElementById('summary-net'); netEl.innerText = `${net >= 0 ? '' : '-'}$${Math.abs(net).toLocaleString()}`;
            netEl.className = `text-xl font-bold ${net >= 0 ? 'text-cocoa' : 'text-red-500'}`;
            const total = (income + expense) || 1;
            document.getElementById('exp-progress').style.width = (expense / total * 100) + '%';
            document.getElementById('inc-progress').style.width = (income / total * 100) + '%';
        }

        function renderLedger() {
            const list = document.getElementById('ledger-list'); list.innerHTML = '';
            const monthStr = document.getElementById('summary-month-select').value;
            const filtered = state.ledger.filter(item => { const d = new Date(item.isoDate); return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}` === monthStr; });
            document.getElementById('ledger-count').innerText = `${filtered.length} TRANSACTIONS`;
            if (filtered.length === 0) { list.innerHTML = `<div class="p-10 text-center opacity-30 font-bold text-xs italic">ä»Šå¤©é‚„æ²’è¨˜å¸³å“¦.áŸ.áŸ.áŸ ( Ë™à¼¥Ë™ )</div>`; return; }
            filtered.forEach(item => {
                const div = document.createElement('div'); div.className = 'ledger-item';
                div.innerHTML = `<div class="flex items-center gap-4"><div class="w-12 h-12 rounded-2xl flex items-center justify-center text-xl ${item.type==='income'?'bg-green-500/10':'bg-red-500/10'}">${getCategoryEmoji(item.category)}</div><div><p class="text-[14px] font-bold">${item.note}</p><p class="text-[10px] opacity-40 font-bold uppercase tracking-tight">${item.displayDate} Â· ${item.displayTime}</p></div></div><div class="flex items-center gap-3"><span class="text-[15px] font-bold ${item.type==='income'?'text-green-600':'text-red-500'}">${item.type==='income'?'+':'-'}$${item.amount.toLocaleString()}</span><button onclick="deleteLedger(${item.id})" class="w-8 h-8 rounded-full bg-black/5 flex items-center justify-center opacity-30 active:opacity-100 transition-opacity"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div>`;
                list.appendChild(div);
            });
        }

        function getCategoryEmoji(cat) { const map = {'é£²é£Ÿ':'ğŸ±','äº¤é€š':'ğŸš—','è³¼ç‰©':'ğŸ›ï¸','å¨›æ¨‚':'ğŸ®','è–ªæ°´':'ğŸ’°','å…¶ä»–':'âœ¨'}; return map[cat] || 'âœ¨'; }
        
        function deleteLedger(id) { state.ledger = state.ledger.filter(l => l.id !== id); save(); renderLedger(); renderSummary(); updateUI(); }
        
        function renderGrids() {
            const g1 = document.getElementById('m1-grid'); g1.innerHTML = '';
            for(let i=1; i<=365; i++) {
                const done = state.m1.includes(i); const div = document.createElement('div'); div.className = `grid-item ${done ? 'completed' : ''}`;
                div.innerHTML = `<span class="opacity-60 mb-0.5">D${i}</span><span class="font-bold">$50</span>`;
                if(!done) div.onclick = () => askConfirm('M1', 50, i); g1.appendChild(div);
            }
            const g2 = document.getElementById('m2-grid'); g2.innerHTML = '';
            for(let i=1; i<=365; i++) {
                const done = state.m2.includes(i); const div = document.createElement('div'); div.className = `grid-item ${done ? 'completed' : ''}`;
                div.innerHTML = `<span class="opacity-60 mb-0.5">D${i}</span><span class="font-bold">$${i}</span>`;
                if(!done) div.onclick = () => askConfirm('M2', i, i); g2.appendChild(div);
            }
        }

        function updateHeartFill(id, percentage) { const rect = document.getElementById(`${id}-fill-rect`); if (rect) { const height = (Math.min(100, percentage) / 100) * 24; rect.setAttribute('y', 24 - height); rect.setAttribute('height', height); } }
        
        function askConfirm(type, amount, id) {
            const modal = document.getElementById('modal'); const desc = document.getElementById('modal-desc'); const title = document.getElementById('modal-title');
            const confirmBtn = document.getElementById('modal-btn'); const cancelBtn = document.getElementById('modal-cancel-btn'); const icon = document.getElementById('modal-icon');
            icon.classList.remove('text-red-500'); icon.classList.add('text-caramel'); cancelBtn.classList.remove('hidden'); cancelBtn.innerText = "å–æ¶ˆ"; confirmBtn.innerText = "ç¢ºèªé¤µé£Ÿ"; title.innerText = "ç¢ºèªé¤µé£Ÿ";
            if (type === 'M1' || type === 'M2') desc.innerHTML = `è¦é¤µé£Ÿ $${amount} å…ƒçµ¦è²¡å¸ƒå›å—ï¼Ÿ<br>ç¢ºèªå¾Œè²¡å¸ƒå›å°±æœƒæŠŠå®ƒåƒé€²å»å“¦ï¼<br>(à¹‘âƒ™âƒ˜Â´à¼¥\`à¹‘âƒ™âƒ˜)`; 
            else if (type === 'Idol') { const idolName = state.idols[state.activeIdolIndex].name || "å¶åƒ"; title.innerText = "æ³¨å…¥æ‡‰æ´åŸºé‡‘"; desc.innerHTML = `è²¡å¸ƒå›å°‡å¹«æ‚¨ç‚º <span class="text-caramel font-bold">${idolName}</span> ä¿ç®¡ <span class="text-caramel font-bold">$${amount}</span> <br> Ù©(ËŠá—œË‹*)Ùˆ`; cancelBtn.classList.add('hidden'); confirmBtn.innerText = "è«‹å¹«æˆ‘ä¿ç®¡ï¼"; }
            modal.classList.add('active');
            confirmBtn.onclick = () => { 
                if(type==='M1') { if(!state.m1.includes(id)) state.m1.push(id); } 
                else if(type==='M2') { if(!state.m2.includes(id)) state.m2.push(id); } 
                else if(type==='Idol') { state.idols[state.activeIdolIndex].total += amount; } 
                save(); renderGrids(); updateUI(); closeModal(); triggerHeartEffect(); 
            };
        }

        function askConfirmGoal() {
            const val = parseInt(document.getElementById('goal-input').value); if (!val || val <= 0) return;
            showModal("ç›®æ¨™ç¢ºèª", `ç¢ºå®šè¨­å®šç›®æ¨™é‡‘é¡ç‚º <span class="text-caramel font-bold">$${val.toLocaleString()}</span> å—ï¼Ÿ<br><span class="text-[10px] text-red-500 font-bold">è¨­å®šå¾Œåœ¨é”æˆå‰ä¸å¯æ›´æ”¹å“¦ï¼</span>`, true, "ç¢ºå®šè¨­å®š", () => { state.idols[state.activeIdolIndex].goal = val; state.idols[state.activeIdolIndex].locked = true; save(); updateUI(); closeModal(); });
        }

        function triggerHeartEffect() {
            const targetHeart = document.getElementById(`heart-target-${state.activeTab}`); if (!targetHeart) return;
            const rect = targetHeart.getBoundingClientRect(); const p = document.createElement('div'); p.className = 'heart-particle pulse-active';
            p.innerHTML = `<svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`;
            document.body.appendChild(p);
            setTimeout(() => { p.classList.replace('pulse-active', 'fly-to-target'); p.style.left = (rect.left + rect.width/2) + 'px'; p.style.top = (rect.top + rect.height/2) + 'px'; p.style.transform = 'translate(-50%,-50%) scale(0.1)'; p.style.opacity = '0'; setTimeout(() => p.remove(), 800); }, 700);
        }

        function resetData() {
            const icon = document.getElementById('modal-icon'); icon.classList.remove('text-caramel'); icon.classList.add('text-red-500');
            showModal("ç¢ºèªæ¸…é™¤å—ï¼Ÿ(Â´;Ï‰;`)", `è²¡å¸ƒå›è£¡ç´¯ç©çš„é»é»æ»´æ»´<br>çœŸçš„éƒ½è¦å…¨éƒ¨æ¸…ç©ºå—ï¼Ÿ<br><span class="text-red-500 font-bold">æ­¤å‹•ä½œç„¡æ³•å¾©åŸå–”ï¼</span>`, true, "å¿ç—›æ¸…é™¤", () => { localStorage.removeItem(NEW_KEY); location.reload(); });
        }

        function checkNotificationStatus() {
            const btn = document.getElementById('notification-toggle');
            if (state.notificationsEnabled && Notification.permission === "granted") { btn.innerText = "æé†’å·²é–‹å•Ÿ âœ“"; btn.style.background = "var(--caramel)"; btn.style.color = "white"; }
            else { btn.innerText = "é–‹å•Ÿæé†’åŠŸèƒ½"; btn.style.background = "transparent"; btn.style.color = "inherit"; state.notificationsEnabled = false; }
        }

        async function toggleNotifications() {
            const permission = await Notification.requestPermission();
            if (permission === "granted") { state.notificationsEnabled = !state.notificationsEnabled; save(); checkNotificationStatus(); }
        }

        function checkReminder() {
            if (!state.notificationsEnabled || Notification.permission !== "granted") return;
            const now = new Date(); const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            if (currentTime === state.reminderTime) new Notification("å­˜éŒ¢æ™‚é–“åˆ°å›‰ï¼- Ì—Ì€( Ë¶^áµ•'Ë¶)b", { body: "ä»Šå¤©ä¹Ÿè¦ä¹–ä¹–çš„æŠŠéŒ¢éŒ¢å­˜ä¸‹ä¾†ï¼(Ùˆ'Ï‰')Ùˆ" });
        }

        function showModal(title, desc, showCancel = true, confirmText = "ç¢ºèª", onConfirm = null) {
            const modal = document.getElementById('modal'); document.getElementById('modal-title').innerText = title; document.getElementById('modal-desc').innerHTML = desc;
            const cancelBtn = document.getElementById('modal-cancel-btn'); const confirmBtn = document.getElementById('modal-btn');
            if (showCancel) cancelBtn.classList.remove('hidden'); else cancelBtn.classList.add('hidden');
            confirmBtn.innerText = confirmText; confirmBtn.onclick = onConfirm || closeModal; modal.classList.add('active');
        }

        function closeModal() { document.getElementById('modal').classList.remove('active'); }
        window.onload = init;
    </script>
</body>
</html>
